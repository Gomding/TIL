# 4. 오류

이장에서 배우는 것
- 시스템이 복구할 수 있는 오류와 복구할 수 없는 오류의 구분
- 신속하게 실패하고 분명하게 실패
- 오류를 전달하기 위한 다양한 기법과 선택을 위한 고려 사항

코드가 실행되는 환경은 불안정하다
- 사용자가 잘못된 입력을 제공
- 외부 시스템이 다운
- 자신이 작성한 코드와 다른 개발자가 작성한 코드가 종종 버그를 발생시킬 수 있음

오류는 불가피하다. 모든 것이 잘못될 수 있고 잘못될 것이기 때문에 오류 사례를 신중하게 생각하지 않고는 경고하고 신뢰성 높은 코드를 작성할 수 없다.

오류에 대해 생각할 때, `소프트웨어가 작동을 계속할 수 있는 오류` 와 `작동을 계속할 합리적인 방법이 없는 오류` 를 구분하는 것이 유용할 때가 많다.

## 복구 가능성

특정 오류가 발생한 경우 복구할 수 있는 현실적인 방법이 있는지 판단

오류가 발생했을 때 무엇을 할 것인지 결정하기 위해서는 자신의 코드가 어떻게 사용될지 신중하게 생각해야 한다.

### 복구 가능한 오류
오류가 발생해도 사용자가 알아채지 못하도록 적절히 처리한다면 작동을 계속할 수 있는 합리적인 방법이 있다.

복구 가능한 오류의 예
- 네트워크 오류: 외부 서비스에 연결할 수 없는 경우는 몇초 후 다시 재시도하여 복구하는 방법이 있다.
- 중요하지 않은 작업 오류: 로깅같은 경우 오류가 발생해도 서비스는 계속 실행해도 될 것이다.

일반적으로 시스템 외부의 무언가에 의해 야기되는 오류에 대해서는 대부분 시스템 전체가 표나지 않고 적절하게 처리하기 위해 노력해야 한다.

### 복구 할 수 없는 오류
오류가 발생하고 시스템이 오류를 복구할 수 있는 합리적인 방법이 없을 때가 있다.

- 코드와 함께 추가되어야 하는 리소스가 없다.
- 코드를 잘못 사용한 경우
  - 잘못된 입력 인수로 호출
  - 일부 필요한 상태를 사전에 초기화하지 않음
  - 오타

오류를 복구할 수 있는 방법이 없다면, 유일하게 코드가 할 수 있는 일은 피해를 최소화하고
개발자가 문제를 발견하고 해결할 가능성을 최대화 하는 것이다.

**신속한 실패 & 요란한 실패** 라는 개념은 바로 이에 대한 것이다.

### 호출하는 쪽에서만 오류 복구 가능 여부를 알 때

대부분의 오류는 한 코드가 다른 코드를 호출할 때 발생한다.

오류 상황을 처리할 때는 다른 코드가 자신이 작성한 코드를 호출하는 것과 관련해 다음과 같은 사항을 신중하게 고려해야한다.
- 오류로부터 복구하기를 호출하는 쪽에서 원하는가?
- 그렇다면 오류를 처리할 필요가 있다는 것을 호출하는 쪽에서 어떻게 알 수 있을까?

일반적으로 다음 중 하나라도 해당되는 경우, 함수에 제공된 값으로 인해 발생하는 오류는 호출하는 쪽에서 복구하고자 하는 것으로 간주해야한다.
- 함수가 어디서 호출될지 그리고 호출 시 제공되는 값이 어디서 올지 정확한 지식이 없다.
- 코드가 미래에 재사용될 가능성이 아주 희박하다.

호출하는 쪽에서 오류로부터 복구하기를 원할 것이라고 판단하는 것은 좋은 일이지만.    
오류가 발생할 수 있다는 것조차 인식하지 못한다면 그것을 제대로 처리하지 못할 것이다.   

#### 호출하는 쪽에서 복구하고자 하는 오류에 대해 인지하도록 해야한다.

함수에서 오류가 발생할 가능성이 있음에도 `함수를 호출하는 쪽`에서 오류를 처리하는 코드를 작성하지 않은 상태라면   
오류가 발생하는 경우 개발자의 예상과는 다른 결과가 발생할 수 있다. 이로 인해 사용자가 버그를 마주하거나 중요한 비즈니스 로직에서 오류가 발생할 수 있다.

따라서 오류가 발생할 가능성이 있는 함수라면 함수를 호출하는 쪽에 오류가 발생할 수 있다는 것을 확실하게 인지하도록 해야 한다.

## 견고성 VS 실패

오류가 발생할 때, 다음 중 하나를 선택해야 한다.

- 견고성 : 오류를 처리하고 계속 진행
- 실패 : 더 높은 코드 계층이 오류를 처리하게 하거나 전체 프로그램의 작동을 멈추게 한다.

### 신속한 실패 

에러가 발생하면 신속하게 실패하여 에러를 알려야한다.    
- 복구할 수 있는 경우 : 호출하는 쪽에서 오류로부터 훌륭하고 안전하게 복구할 수 있는 기회를 최대한으로 제공    
- 복구할 수 없는 경우 : 개발자가 문제를 신속하게 파악하고 해결할 수 있는 기회를 최대한 제공

오류가 발생했을 때 신속하게 실패하지 않으면, 오류는 **실제 위치에서 멀리 떨어진 코드에서 나타날 수 있다.**

### 요란한 실패

요란한 실패란 오류가 발생하는데도 불구하고 아무도 모르는 상황을 막고자 하는 것이다.     
가장 명백한 방법은 예외를 발생시켜 프로그램이 중단되게 하는 것

코드가 실패할 때 신속하고 요란하게 오류를 나타내면 개발 도중이나 테스트하는 동안에 버그가 발견될 가능성이 크다.

### 오류를 숨기는 방법들

오류를 숨기는 것은 일반적으로 바람직하지 않다. 극히 일부 상황에서만 유용할 것이다.    
**오류가 발생하면 알리는 것이 좋다.**

- 기본값 반환
- 널 객체 패턴
- 아무것도 하지 않음

### 오류 전달 방법

- 명시적 방법 : 코드 계약에 오류에 대한 내용이 명확함. 호출하는 쪽에서는 오류가 발생할 수 있음을 인지할 수 밖에 없도록 한다.
  - 검사 예외 (Checked Exception)
  - Null 반환 유형 (널 안전성의 경우)
  - Optional 반환 유형
  - Result 반환 유형
  - 아웃컴 반환 유형 : 동작의 결과를 나타내는 값을 반환하는 방법. (ex. 성공하면 true 실패하면 false 반환) 반환하는 값을 강제적으로 확인하도록 하면 명시적 방법이 된다. (자바의 `@CheckReturnValue` 같은 애너테이션) 
  - 스위프트 오류
- 암시적 방법 : 코드 계약의 세부 조항을 통해 오류에 대한 설명이 제공되거나 전혀 설명이 없을 수 있다. 오류가 발생할 수 있다는 것을 호출하는 쪽에서 반드시 인지하는 것은 아니다. (오류가 발생함을 알기 위해선 코드나 문서를 읽는 적극적인 노력이 필요)
  - 비검사 예외 (Unchecked Exception)
  - 매직값 반환
  - 프로미스 또는 퓨쳐
  - assertion
  - 체크
  - 패닉

### 복구할 수 없는 오류의 전달

복구할 가능성이 없는 오류가 발생하면 `신속하게 실패하고`, `요란하게 실패하는 것`이 최선의 방법이다.

이를 달성하기 위한 방법
- 비검사 예외 발생
- 프로그램이 패닉(panic)이 되도록(패닉을 지원하는 언어를 사용하는 경우. ex. 언어 Go는 panic 을 지원함)
- 체크나 어서션을 사용

이런 경우 프로그램이 종료되는데, 이는 개발자들이 뭔가 잘못되었음을 알아차린다는 것을 의미.    
생성된 오류 메시지는 대개 스택 트레이스나 코드 line 번호를 제공하여 오류가 발생한 위치를 명확하게 알려준다.

오류를 복구할 방법이 없을 때는 이것이 합리적이다. 왜냐하면 자신을 호출한 쪽에 오류를 전달하는 것 이외에는 할 수 있는 방법이 없기 때문이다.

### 호출하는 쪽에서 복구하기를 원할 수도 있는 오류의 전달

이 부분은 개발자들 사이에도 논쟁이 있는 부분이다.

- 비 검사 예외를 사용해야 한다는 주장
  - 대부분의 오류 처리가 코드의 상위 계층에서 이루어질 수 있기 때문에
  - 비검사 예외를 발생시키면 코드 구조를 개선할 수 있다고 주장하는 개발자들이 있다.
  - 오류가 높은 계층까지 거슬러 올라오면서 전달되고, 그 사이에 있는 코드들은 오류 처리를 할 필요가 없다.
  - 핵심 장점은 오류를 처리하는 로직이 코드 전체에 퍼지지 않고 별도로 몇 개의 계층에만 있다는 점
  - 너무 많은 명시적 오류 전달을 사용하면 예외를 포착하고도 무시한다거나 널이 가능한 유형을 확인도 하지 않고 널이 불가능한 유형으로 변환하고 싶은 유혹이 생긴다.
  - 오류를 숨기는것은 결코 좋은 일이 아니므로 잘못된 작업을 하도록 유도하게 될 수 있다.
- 명시적 오류 전달 기법을 사용해야 한다는 주장
  - 매끄러운 오류 처리. 명시적 오류 전달을 통해 호출하는 쪽에 잠재적 오류를 강제적으로 인식하도록 하면 이러한 오류를 좀 더 매끄럽게 처리할 가능성이 커진다.
  - 암시적인 방법을 사용하면 개발자는 오류가 일어날 수 있다는 것을 알지도 못하는데 어떻게 처리할 수 있는가?
  - 실수로 오류를 무시할 수 없다. 만약 예외를 처리했지만 제대로 처리하지 않았다면 코드 검수 시 명확하게 드러나게 되고, 잘못된 코드를 차단할 가능성이 커진다.
  - 개발자들이 명시적 오류 처리 때문에 잘못된 처리를 한다는 주장은 비검사 예외에도 적용할 수 있다.
  - 비검사 예외는 문서화가 된다는 보장이 없고, 문서화 안되는 경우가 많다. 이는 종종 어떤 코드가 어떤 예외를 발생시킬 것인지 확실하게 알지 못한다는 것을 의미하고, 이로 인해 혼란을 가중할 수 있다.

### 컴파일러 경고를 무시하지 말라

컴파일러 오류 뿐만 아니라 대부분의 컴파일러는 경고 메시지도 출력한다.

경고는 어떤 식으로든 코드가 의심스러우면 표시를 한다. 이는 버그에 대한 조기 경고일 수 있다.

이러한 경고에 주의를 기울이면 코드베이스에 병합되기 훨씬 전에 코드로부터 프로그래밍 오류를 발견하고 제거할 수 있다.

**경고는 단지 경고일 뿐이지만, 종종 코드에 문제가 있다는 신호일 수 있으며, 어떤 상황에서는 심각한 버그가 될 수 있다.**


